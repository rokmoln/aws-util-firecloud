{"version":3,"sources":["../../src/express/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/* eslint-disable no-invalid-this */\nimport Layer from 'express/lib/router/layer';\nimport _ from 'lodash-firecloud';\nimport _express from 'express';\nimport bearerToken from 'express-bearer-token';\nimport cors from 'cors';\nimport middlewares from './middlewares';\nimport responseTime from 'response-time';\n\nimport {\n  bootstrap as bootstrapLambda\n} from '../lambda';\n\nimport {\n  LambdaHttp\n} from 'http-lambda';\n\nlet _bootstrapLayer = function() {\n  // override Layer.prototype as defined in express@4.16.4\n  Layer.prototype.handle_error = async function(error, req, res, next) {\n    let fn = this.handle;\n\n    if (fn.length !== 4) {\n      // not a standard error handler\n      return next(error);\n    }\n\n    try {\n      // original code\n      // fn(error, req, res, next);\n      await fn(error, req, res, next);\n    } catch (err) {\n      return next(err);\n    }\n  };\n\n  Layer.prototype.handle_request = async function(req, res, next) {\n    let fn = this.handle;\n\n    if (fn.length > 3) {\n      // not a standard request handler\n      return next();\n    }\n\n    try {\n      // original code\n      // fn(req, res, next);\n      await fn(req, res, next);\n    } catch (err) {\n      return next(err);\n    }\n  };\n};\n\nlet _bootstrap = async function(fn, e, ctx) {\n  _bootstrapLayer();\n  let app = _express(e);\n\n  app.disable('x-powered-by');\n  app.disable('etag');\n  app.enable('trust proxy');\n  app.set('json spaces', 2);\n\n  let defaultMiddlewares = {};\n  defaultMiddlewares.responseTime = responseTime();\n  defaultMiddlewares.cors = cors({\n    exposedHeaders: [\n      'date',\n      'etag',\n      'link',\n      'location',\n      'x-response-time'\n    ],\n    maxAge: 24 * 60 * 60 // 24 hours\n  });\n  defaultMiddlewares.bearerToken = bearerToken();\n  defaultMiddlewares.applyMixins = middlewares.applyMixins();\n  defaultMiddlewares.xForward = middlewares.xForward();\n  defaultMiddlewares.noCache = function(_req, res, next) {\n    res.set('cache-control', 'max-age=0, no-store');\n    next();\n  };\n\n  _.forEach(defaultMiddlewares, function(middleware, name) {\n    middleware.disable = function() {\n      defaultMiddlewares[name] = function(_req, _res, next) {\n        next();\n      };\n    };\n\n    app.use(function(req, res, next) {\n      defaultMiddlewares[name](req, res, next);\n    });\n  });\n\n  app.defaultMiddlewares = defaultMiddlewares;\n\n  await fn(app, e, ctx);\n\n  // error handlers need to be registered last\n  app.use(middlewares.handleResponseError());\n\n  return app;\n};\n\nexport let bootstrap = function(fn, {\n  pkg\n}) {\n  return bootstrapLambda(async function(e, ctx) {\n    let app;\n    await ctx.log.trackTime(\n      'Creating express app...',\n      async function() {\n        app = await _bootstrap(fn, e, ctx);\n      }\n    );\n\n    let result;\n    ctx.log.info('Creating HTTP server (handling request)...');\n    await ctx.log.trackTime(\n      'Creating HTTP server (handling request)...',\n      _.promisify(function(done) {\n        let http = new LambdaHttp(e, ctx, function(err, resData) {\n          if (_.isUndefined(err)) {\n            result = resData;\n          }\n          done(err);\n        });\n        http.createServer(app);\n      })\n    );\n\n    return result;\n  }, {\n    pkg\n  });\n};\n\nexport default exports;\n"]}