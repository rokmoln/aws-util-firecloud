{"version":3,"sources":["../src/firehose.js"],"names":[],"mappings":";;;;;;;;;AAAA;;;;AACA;;;;AAEA;;;;AAIO,IAAI,gFAAJ;;AAEP;AACO,IAAI,0BAAS;AAClB,iBAAe,IAAI,IAAJ,GAAW,IADR;AAElB,eAAa,GAFK;AAGlB,kBAAgB,OAAO;AAHL,CAAb;;AAMA,IAAI;AAAA,sCAAoB,WAAe,EAAC,QAAD,EAAW,aAAX,EAAf,EAA0C;AACvE,QAAI,0BAAE,OAAF,CAAU,aAAV,CAAJ,EAA8B;AAC5B;AACD;;AAED,QAAI,cAAc,cAAc,GAAd,EAAlB;AACA,WAAO,YAAY,QAAnB;AACA,UAAM,SAAS,cAAT,CAAwB,WAAxB,EAAqC,OAArC,EAAN;AACA,UAAM,QAAQ,iBAAR,CAA0B,aAA1B,CAAN;AACD,GATU;;AAAA;AAAA;AAAA;AAAA,IAAJ;;AAWA,IAAI;AAAA,uCAAa,WAAe;AACrC,sBADqC;AAErC,OAFqC;AAGrC,eAAW,IAAI,iBAAI,QAAR,EAH0B;AAIrC;AAJqC,GAAf,EAKrB;AACD,QAAI,gBAAgB,EAApB;AACA,QAAI,cAAc;AAChB,wBADgB;AAEhB,eAAS,EAFO;AAGhB,gBAAU;AAHM,KAAlB;;AAMA,8BAAE,OAAF,CAAU,OAAV,EAAmB,UAAS,MAAT,EAAiB;AAClC,UAAI,OAAO,KAAK,SAAL,CAAe,MAAf,CAAX;AACA,aAAQ,GAAE,IAAK,IAAf;AACA,UAAI,aAAa,OAAO,UAAP,CAAkB,IAAlB,CAAjB;;AAEA,UAAI,aAAa,QAAQ,MAAR,CAAe,cAAhC,EAAgD;AAC9C,YAAI,GAAJ,CAAQ,KAAR,CAAe,+BAA8B,QAAQ,MAAR,CAAe,cAAf,GAAgC,IAAK;EACtF,aAAa,IAAK,MADd,EACqB,EAAC,MAAD,EADrB;AAEA;AACD;;AAED,UAAI,YAAY,QAAZ,GAAuB,UAAvB,GAAoC,QAAQ,MAAR,CAAe,aAAnD,IACA,YAAY,OAAZ,CAAoB,MAApB,GAA6B,CAA7B,GAAiC,QAAQ,MAAR,CAAe,WADpD,EACiE;AAC/D,sBAAc,IAAd,CAAmB,WAAnB;AACA,sBAAc;AACZ,4BADY;AAEZ,mBAAS,EAFG;AAGZ,oBAAU;AAHE,SAAd;AAKD;;AAED,kBAAY,QAAZ,GAAuB,YAAY,QAAZ,GAAuB,UAA9C;;AAEA,kBAAY,OAAZ,CAAoB,IAApB,CAAyB;AACvB;AADuB,OAAzB;AAGD,KA1BD;;AA4BA,kBAAc,IAAd,CAAmB,WAAnB;AACA,8BAAE,MAAF,CAAS,aAAT,EAAwB,EAAC,UAAU,CAAX,EAAxB;;AAEA,UAAM,QAAQ,iBAAR,CAA0B,EAAC,QAAD,EAAW,aAAX,EAA1B,CAAN;AACD,GA7CU;;AAAA;AAAA;AAAA;AAAA,IAAJ;;kBA+CQ,O","file":"firehose.js","sourcesContent":["import _ from 'lodash-firecloud';\nimport aws from 'aws-sdk';\n\nimport {\n  getLambdaTableName\n} from './dynamodb';\n\nexport let getLambdaStreamName = getLambdaTableName;\n\n// see https://docs.aws.amazon.com/firehose/latest/dev/limits.html\nexport let limits = {\n  batchByteSize: 4 * 1024 * 1024,\n  batchRecord: 500,\n  recordByteSize: 1000 * 1024\n};\n\nexport let _putRecordBatches = async function({firehose, recordBatches}) {\n  if (_.isEmpty(recordBatches)) {\n    return;\n  }\n\n  let recordBatch = recordBatches.pop();\n  delete recordBatch.byteSize;\n  await firehose.putRecordBatch(recordBatch).promise();\n  await exports._putRecordBatches(recordBatches);\n};\n\nexport let putRecords = async function({\n  DeliveryStreamName,\n  ctx,\n  firehose = new aws.Firehose(),\n  records\n}) {\n  let recordBatches = [];\n  let recordBatch = {\n    DeliveryStreamName,\n    Records: [],\n    byteSize: 0\n  };\n\n  _.forEach(records, function(record) {\n    let Data = JSON.stringify(record);\n    Data = `${Data}\\n`;\n    let dataLength = Buffer.byteLength(Data);\n\n    if (dataLength > exports.limits.recordByteSize) {\n      ctx.log.error(`Skipping record larger than ${exports.limits.recordByteSize / 1024} KB: \\\n${dataLength / 1024} KB.`, {record});\n      return;\n    }\n\n    if (recordBatch.byteSize + dataLength > exports.limits.batchByteSize ||\n        recordBatch.Records.length + 1 > exports.limits.batchRecord) {\n      recordBatches.push(recordBatch);\n      recordBatch = {\n        DeliveryStreamName,\n        Records: [],\n        byteSize: 0\n      };\n    }\n\n    recordBatch.byteSize = recordBatch.byteSize + dataLength;\n\n    recordBatch.Records.push({\n      Data\n    });\n  });\n\n  recordBatches.push(recordBatch);\n  _.remove(recordBatches, {byteSize: 0});\n\n  await exports._putRecordBatches({firehose, recordBatches});\n};\n\nexport default exports;\n"]}