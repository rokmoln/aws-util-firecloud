{"version":3,"sources":["../src/dynamodb.ts"],"names":[],"mappings":"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","file":"dynamodb.js","sourcesContent":["import _ from 'lodash-firecloud';\nimport aws from 'aws-sdk';\n\nexport let getDefaultTotalSegments = async function(TableName: aws.DynamoDB.TableName): Promise<number> {\n  let db = new aws.DynamoDB();\n  let {\n    Table\n  } = await db.describeTable({TableName}).promise();\n\n  let TwoGigabytesInBytes = 2 * 1024 * 1024 * 1024;\n  return Math.floor(Table.TableSizeBytes / TwoGigabytesInBytes) + 1;\n};\n\nexport let scanWithBackticks = function(\n  args: aws.DynamoDB.DocumentClient.ScanInput\n): aws.DynamoDB.DocumentClient.ScanInput {\n  if (_.isUndefined(args.FilterExpression)) {\n    return args;\n  }\n\n  args.ExpressionAttributeNames = _.defaultTo(args.ExpressionAttributeNames, {});\n  args.FilterExpression = _.replace(args.FilterExpression, /`([^`]+)`/g, function(_match, attrs) {\n    attrs = _.split(attrs, '.');\n    attrs = _.map(attrs, function(attr) {\n      attr = _.replace(attr, /^#/, '');\n      let safeAttr = _.replace(attr, /[^A-Za-z0-9]/g, '_');\n      safeAttr = `#${safeAttr}`;\n      // FIXME should I even bother checking if this is a reserved word\n      args.ExpressionAttributeNames[safeAttr] = attr;\n      return safeAttr;\n    });\n    attrs = attrs.join('.');\n    return attrs;\n  });\n  return args;\n};\n\nexport let dcScan = async function(args: aws.DynamoDB.DocumentClient.ScanInput, iteratee): Promise<void> {\n  let dc = new aws.DynamoDB.DocumentClient();\n\n  args = scanWithBackticks(args);\n  // NOTE: we disable parallel scanning for now\n  // until we reach >2GB dynamodb tables\n  // args.TotalSegments =\n  //   _.defaultTo(args.TotalSegments,\n  //   await getDefaultTotalSegments(args.TableName));\n  args.TotalSegments = 1;\n  args.TotalSegments = _.max([\n    1,\n    args.TotalSegments\n  ]);\n\n  if (_.isDefined(args.Limit)) {\n    args.Limit = _.ceil(args.Limit / args.TotalSegments);\n  }\n\n  let continueScan = true;\n  let results = [] as aws.DynamoDB.DocumentClient.ScanOutput[];\n  let limit: aws.DynamoDB.DocumentClient.ScanInput['Limit'];\n\n  let scan = async function(): Promise<void> {\n    await Promise.all(_.map(_.range(0, args.TotalSegments), async function(Segment) {\n      let iteratorArgs = _.cloneDeep(args);\n      iteratorArgs.Segment = Segment;\n\n      if (_.isDefined(results[Segment])) {\n        iteratorArgs.ExclusiveStartKey = results[Segment].LastEvaluatedKey;\n      }\n      // eslint-disable-next-line require-atomic-updates\n      results[Segment] = await dc.scan(iteratorArgs).promise();\n    }));\n\n    _.forEach(results, function(result) {\n      let cbResult = _.defaultTo(iteratee(result), true);\n\n      if (_.isBoolean(cbResult)) {\n        cbResult = {\n          continueScan: cbResult\n        };\n      }\n\n      limit = _.get(cbResult, 'args.Limit');\n      continueScan =\n        cbResult.continueScan !== false &&\n        _.isDefined(result.LastEvaluatedKey);\n\n      return continueScan;\n    });\n\n    if (!continueScan) {\n      return;\n    }\n\n    if (_.isDefined(limit)) {\n      // eslint-disable-next-line require-atomic-updates\n      args.Limit = _.ceil(limit / args.TotalSegments);\n    }\n\n    await scan();\n  };\n\n  await scan();\n};\n\nexport let dcPut = async function(\n  args: aws.DynamoDB.DocumentClient.PutItemInput\n): Promise<aws.DynamoDB.DocumentClient.PutItemOutput> {\n  let dc = new aws.DynamoDB.DocumentClient();\n\n  args.Item = _.mapValuesDeep(_.pickBy.bind(_))(args.Item, function(value) {\n    return _.isDefined(value) && value !== '';\n  });\n\n  return await dc.put(args).promise();\n};\n"]}