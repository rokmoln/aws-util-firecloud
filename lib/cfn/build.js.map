{"version":3,"sources":["../../src/cfn/build.ts"],"names":[],"mappings":"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","file":"build.js","sourcesContent":["// eslint-disable-next-line import/no-unassigned-import\nimport '../bootstrap';\n\nimport _ from 'lodash-firecloud';\nimport path from 'path';\n\nimport {\n  reduceToDependsOn\n} from '.';\n\nlet _surfaceDependsOn = function(tpl) {\n  // CloudFormation behaviour becomes safer (as per AWS support conversations)\n  // if you spell out the DependsOn field, rather than rely on CloudFormation\n  // to imply that based on Refs and Fn::GetAtt...\n  _.forEach(_.pickBy(tpl.Resources), function(Resource) {\n    let deps = _.reduce(Resource, reduceToDependsOn, []);\n    // keep only dependencies on other resources\n    deps = _.intersection(deps, _.keys(tpl.Resources));\n    Resource.DependsOn = _.defaultTo(Resource.DependsOn, []);\n    Resource.DependsOn = [].concat(Resource.DependsOn).concat(deps);\n    Resource.DependsOn = Resource.DependsOn.length > 0 ? Resource.DependsOn : undefined;\n  });\n};\n\nlet _standardizeSids = function(tpl) {\n  // CloudFormation does not have consistent rules for Sids (statement ids)\n  _.forEach(_.pickBy(tpl.Resources), function(Resource) {\n    switch (Resource.Type) {\n    case 'AWS::IAM::ManagedPolicy':\n    case 'AWS::S3::BucketPolicy':\n    case 'AWS::SNS::TopicPolicy':\n      _.forEach(Resource.Properties.PolicyDocument.Statement, function(Stmt) {\n        Stmt.Sid = _.camelCase(Stmt.Sid);\n      });\n      break;\n    case 'AWS::KMS::Key':\n      _.forEach(Resource.Properties.KeyPolicy.Statement, function(Stmt) {\n        Stmt.Sid = _.camelCase(Stmt.Sid);\n      });\n      break;\n    default:\n    }\n  });\n};\n\nexport let build = async function(args) {\n  let {\n    incs = [],\n    partial = false\n  }: {\n    incs: any[];\n    partial: boolean;\n  } = args;\n\n  // e.g. {env, resNs, vars}\n  let incArgs = _.omit(args, [\n    'incs',\n    'partial'\n  ]);\n\n  let tpl = {};\n\n  incs = _.map(incs, function(inc) {\n    if (_.isFunction(inc)) {\n      return inc;\n    }\n\n    if (!_.isString(inc)) {\n      throw new Error(`Received inc as '${inc}' but expected a string at this point.`);\n    }\n\n    if (!path.isAbsolute(inc)) {\n      inc = path.join(process.cwd(), inc);\n    }\n    let incModule = inc;\n    // eslint-disable-next-line global-require, @typescript-eslint/no-require-imports\n    inc = require(incModule);\n    inc = (inc.__esModule as boolean) ? inc.default : inc;\n\n    if (!_.isFunction(inc)) {\n      throw new Error(`Received inc as '${inc}' (from module '${incModule}') but expected a function at this point.`);\n    }\n    return inc;\n  });\n\n  for (let inc of incs) {\n    let partialTpls = await inc(incArgs);\n\n    // allow the main function to return multiple partial templates\n    if (!_.isArray(partialTpls)) {\n      partialTpls = [\n        partialTpls\n      ];\n    }\n\n    _.merge(tpl, ...partialTpls);\n  }\n\n  if (!partial) {\n    _surfaceDependsOn(tpl);\n    _standardizeSids(tpl);\n  }\n\n  return tpl;\n};\n\nexport default build;\n"]}