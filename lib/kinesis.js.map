{"version":3,"sources":["../src/kinesis.ts"],"names":[],"mappings":"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","file":"kinesis.js","sourcesContent":["import _ from 'lodash-firecloud';\nimport aws from 'aws-sdk';\n\nimport {\n  LambdaContext\n} from './types';\n\ntype RecordBatch = {\n  StreamName: aws.Kinesis.StreamName;\n  Records: aws.Kinesis.PutRecordsRequestEntry[];\n  byteSize: number;\n};\n\n// see https://docs.aws.amazon.com/kinesis/latest/APIReference/API_PutRecords.html\nexport let limits = {\n  batchByteSize: 5 * 1024 * 1024,\n  batchRecord: 500,\n  recordByteSize: 1024 * 1024\n};\n\nlet _putRecordBatches = async function({\n  kinesis,\n  recordBatches\n}: {\n  kinesis: aws.Kinesis;\n  recordBatches: RecordBatch[];\n}): Promise<number> {\n  let processedCount = 0;\n\n  for (let recordBatch of recordBatches) {\n    await kinesis.putRecords({\n      StreamName: recordBatch.StreamName,\n      Records: recordBatch.Records\n    }).promise();\n    processedCount = processedCount + recordBatch.Records.length;\n  }\n\n  return processedCount;\n};\n\nexport let putRecords = async function({\n  ExplicitHashKey,\n  PartitionKey,\n  StreamName,\n  ctx,\n  kinesis = new aws.Kinesis(),\n  records\n}: {\n  ExplicitHashKey: aws.Kinesis.HashKey;\n  PartitionKey: aws.Kinesis.PartitionKey;\n  StreamName: aws.Kinesis.StreamName;\n  ctx: LambdaContext;\n  kinesis: aws.Kinesis;\n  records: any[];\n}): Promise<void | {\n    largeRecords: aws.Kinesis.PutRecordsRequestEntry[];\n  }> {\n  let largeRecords = [] as aws.Kinesis.PutRecordsRequestEntry[];\n  let recordBatches = [] as RecordBatch[];\n  let recordBatch = {\n    StreamName,\n    Records: [],\n    byteSize: 0\n  } as RecordBatch;\n\n  let toProcessCount = records.length;\n\n  for (let record of records) {\n    let Data = JSON.stringify(record);\n    let dataByteSize = Buffer.byteLength(JSON.stringify({\n      Data: record,\n      ExplicitHashKey,\n      PartitionKey\n    }));\n\n    if (dataByteSize > limits.recordByteSize) {\n      largeRecords.push(record);\n      await ctx.log.error(`Skipping record larger than ${limits.recordByteSize / 1024} KB: \\\n${dataByteSize / 1024} KB.`, {\n        record\n      });\n      toProcessCount = toProcessCount - 1;\n      continue;\n    }\n\n    if (recordBatch.byteSize + dataByteSize > limits.batchByteSize ||\n        recordBatch.Records.length + 1 > limits.batchRecord) {\n      recordBatches.push(recordBatch);\n      recordBatch = {\n        StreamName,\n        Records: [],\n        byteSize: 0\n      } as RecordBatch;\n    }\n\n    recordBatch.byteSize = recordBatch.byteSize + dataByteSize;\n\n    recordBatch.Records.push({\n      Data,\n      PartitionKey\n    });\n  }\n\n  recordBatches.push(recordBatch);\n  recordBatches = _.reject(recordBatches, function(recordBatch) {\n    return recordBatch.byteSize === 0;\n  });\n\n  let processedCount = await _putRecordBatches({kinesis, recordBatches});\n  if (processedCount !== toProcessCount) {\n    throw new Error(`Not all records processed. Expected ${toProcessCount}, actually ${processedCount}.`);\n  }\n\n  return {\n    largeRecords\n  };\n};\n"]}