{"version":3,"sources":["../src/express.js"],"names":[],"mappings":"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","file":"express.js","sourcesContent":["/* eslint-disable no-invalid-this */\nimport _ from 'lodash-firecloud';\nimport _express from 'express';\nimport bearerToken from 'express-bearer-token';\nimport cors from 'cors';\nimport http from 'http';\nimport responseTime from 'response-time';\nimport url from 'url';\n\nimport {\n  bootstrap as bootstrapLambda,\n  getRequestInstance\n} from './lambda';\n\nimport {\n  bootstrap as bootstrapMiddleware\n} from './express-middleware';\n\nimport {\n  httpLambda\n} from 'http-lambda';\n\nexport let _resAddLink = function(link) {\n  let {target} = link;\n  delete link.target;\n  let linkStr = [`<${target}>`];\n\n  // eslint-disable-next-line lodash/prefer-map\n  _.forEach(link, function(value, key) {\n    linkStr.push(`${key}=\"${value}\"`);\n  });\n\n  linkStr = linkStr.join('; ');\n  this._headers.link = _.defaultTo(this._headers.link, []);\n  this._headers.link.push(linkStr);\n};\n\nexport let _resSend = function(oldSend, body, mediaType) {\n  this.send = oldSend;\n\n  if (mediaType) {\n    this.set('content-type', mediaType);\n  }\n\n  if (!_.isUndefined(this.validate) &&\n      _.startsWith(this.get('content-type'), this.validate.schema.mediaType)\n    ) {\n    let valid = this.validate(body);\n    if (!valid) {\n      this.log.error({\n        errors: this.validate.errors,\n        body,\n        schema: this.validate.schema,\n        req: this.req,\n        res: this\n      }, 'Response validation failed!');\n    }\n  }\n\n  return this.send(body);\n};\n\nexport let _resSendError = function(status, extensions = {}) {\n  this.status(status);\n\n  let contentType = 'application/problem+json';\n  let body = _.merge({\n    type: 'about:blank',\n    title: http.STATUS_CODES[status],\n    status,\n    instance: this.instance\n  }, extensions);\n  this.send(body, contentType);\n\n  let err = new Error();\n  err.contentType = 'application/problem+json';\n  err.body = body;\n  return err;\n};\n\nexport let _reqGetBody = function() {\n  let {body} = this;\n  try {\n    if (/[/+]json$/.test(this.get('content-type'))) {\n      body = JSON.parse(this.body);\n    }\n  } catch (syntaxErrors) {\n    return this.res.sendError(400, {errors: syntaxErrors});\n  }\n\n  if (!_.isUndefined(this.validate)) {\n    let valid = this.validate(body);\n    if (!valid) {\n      return this.res.sendError(422, {\n        errors: this.validate.errors,\n        schema: this.validate.schema\n      });\n    }\n  }\n\n  return body;\n};\n\nexport let _initExpress = function() {\n  return bootstrapMiddleware(async function(req, res, next) {\n    req.log = req.ctx.log;\n    res.log = req.log;\n    res.instance = getRequestInstance(req);\n    req.getBody = _.memoize(exports._reqGetBody.bind(req));\n    let oldSend = res.send;\n    res.addLink = _.bind(exports._resAddLink, res);\n    res.send = _.bind(exports._resSend, res, oldSend);\n    res.sendError = _.bind(exports._resSendError, res);\n    next();\n  });\n};\n\nexport let _xForward = function() {\n  return bootstrapMiddleware(async function(req, _res, next) {\n    req.headers = _.mapKeys(req.headers, function(_value, key) {\n      return _.replace(key, /^X-Forward-/, '');\n    });\n    next();\n  });\n};\n\nexport let getSelfUrl = function({req}) {\n  let {env} = req.ctx;\n  let selfUrl = url.parse(`${env.API_SECONDARY_BASE_URL}${req.originalUrl}`, true, true);\n  delete selfUrl.search;\n  return selfUrl;\n};\n\nexport let getPageUrl = function({req, per_page, ref}) {\n  let pageUrl = exports.getSelfUrl({req});\n  _.merge(pageUrl, {\n    query: {\n      per_page,\n      ref\n    }\n  });\n  return pageUrl;\n};\n\nexport let express = function({e}) {\n  let app = _express();\n\n  app.disable('x-powered-by');\n  app.disable('etag');\n  app.enable('trust proxy');\n  app.set('json spaces', 2);\n  app.validate = exports.validate;\n\n  // FIXME hack!!!\n  let host = _.get(e, 'headers.Host', _.get(e, 'headers.host'));\n  if (_.startsWith(host, 'api-git.')) {\n    // using the api-git apigateway-domainname (ci stack)\n    let basePath = _.split(url.parse(e.path).pathname, '/')[1];\n    app.lazyrouter();\n    app.use(`/${basePath}`, app._router);\n  }\n\n  app.use(responseTime());\n  app.use(cors({\n    allowedHeaders: [\n      'authorization',\n      'content-type',\n      'If-Match'\n    ],\n    maxAge: 24 * 60 * 60 // 24 hours\n  }));\n  app.use(bearerToken());\n  app.use(exports._initExpress());\n  app.use(exports._xForward());\n\n  app.use(bootstrapMiddleware(async function(_req, res, next) {\n    res.set('cache-control', 'max-age=0, no-store');\n    next();\n  }));\n\n  return app;\n};\n\n// using console.log instead of the logger on purpose\nexport let bootstrap = function(fn, {pkg}) {\n  return bootstrapLambda(async function(e, ctx, next) {\n    // eslint-disable-next-line no-console\n    console.log('aws-util-firecloud.express.bootstrap: Setting up timeout handler...');\n\n    let timeoutInterval = setInterval(function() {\n      // FIXME this could be simulated as well for a lambda-proxy environment, but not now\n      if (!ctx.getRemainingTimeInMillis) {\n        return;\n      }\n      let remainingTimeInMillis = ctx.getRemainingTimeInMillis();\n      if (remainingTimeInMillis > 1000) {\n        return;\n      }\n\n      clearInterval(timeoutInterval);\n\n      let status = 524;\n      let title = 'A Timeout Occurred';\n\n      if (_.includes([\n        'OPTIONS',\n        'HEAD',\n        'GET'\n      ], e.httpMethod)) {\n        // signal API gateway to retry request\n        // see https://docs.aws.amazon.com/apigateway/api-reference/handling-errors/\n        status = 503;\n        title = 'Service Unavailable';\n      }\n\n      // eslint-disable-next-line no-console\n      console.error(`aws-util-firecloud.express.bootstrap: Lambda will timeout in ${remainingTimeInMillis} ms`);\n      // eslint-disable-next-line no-console\n      console.error(`aws-util-firecloud.express.bootstrap: Terminating with ${status} ${title}...`);\n\n      next(undefined, { // eslint-disable-line callback-return\n        statusCode: 524,\n        headers: {\n          'content-type': 'application/problem+json'\n        },\n        body: JSON.stringify({\n          type: 'about:blank',\n          title,\n          status,\n          instance: getRequestInstance({ctx}),\n          renderer: 'lambda-util'\n        })\n      });\n\n      // don't process.exit()\n    }, 500);\n\n    await _.consoleLogTime('aws-util-firecloud.express.bootstrap: Running httpLambda...', async function() {\n      httpLambda(function(http, e, ctx, _next) {\n        (async function() {\n          let app;\n\n          await _.consoleLogTime(\n            'aws-util-firecloud.express.bootstrap: Creating express app...',\n            async function() {\n              app = exports.express({e});\n            }\n          );\n\n          await _.consoleLogTime(\n            'aws-util-firecloud.express.bootstrap: Setting up custom express...',\n            async function() {\n              await fn(app, e, ctx, next);\n            }\n          );\n\n          await _.consoleLogTime(\n            'aws-util-firecloud.express.bootstrap: Creating HTTP server = running request...',\n            async function() {\n              http.createServer(app);\n            }\n          );\n        })();\n      })(e, ctx, function() {\n        clearInterval(timeoutInterval);\n        // eslint-disable-next-line fp/no-arguments\n        next(...arguments);\n      });\n    });\n  }, {pkg});\n};\n\nexport default exports;\n"]}