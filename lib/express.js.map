{"version":3,"sources":["../src/express.js"],"names":[],"mappings":"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","file":"express.js","sourcesContent":["/* eslint-disable no-invalid-this */\nimport _ from 'lodash-firecloud';\nimport _express from 'express';\nimport bearerToken from 'express-bearer-token';\nimport cors from 'cors';\nimport http from 'http';\nimport responseTime from 'response-time';\nimport urlLib from 'url';\n\nimport {\n  LambdaHttp\n} from 'http-lambda';\n\nimport {\n  bootstrap as bootstrapLambda,\n  getRequestInstance\n} from './lambda';\n\nimport {\n  bootstrap as bootstrapMiddleware\n} from './express-middleware';\n\nimport {\n  format as urlFormat,\n  parse as urlParse\n} from './url';\n\nlet _resAddLink = function(link) {\n  let {target} = link;\n  delete link.target;\n  let linkStr = [`<${target}>`];\n\n  // eslint-disable-next-line lodash/prefer-map\n  _.forEach(link, function(value, key) {\n    linkStr.push(`${key}=\"${value}\"`);\n  });\n\n  linkStr = linkStr.join('; ');\n  this._headers.link = _.defaultTo(this._headers.link, []);\n  this._headers.link.push(linkStr);\n};\n\nlet _resSend = function(oldSend, body, mediaType) {\n  this.send = oldSend;\n\n  if (mediaType) {\n    this.set('content-type', mediaType);\n  }\n\n  if (!_.isUndefined(this.validate) &&\n      _.startsWith(this.get('content-type'), this.validate.schema.mediaType)\n    ) {\n    let valid = this.validate(body);\n    if (!valid) {\n      this.log.error({\n        errors: this.validate.errors,\n        body,\n        schema: this.validate.schema,\n        req: this.req,\n        res: this\n      }, 'Response validation failed!');\n    }\n  }\n\n  return this.send(body);\n};\n\nlet _resSendError = function(status, extensions = {}) {\n  this.status(status);\n\n  let contentType = 'application/problem+json';\n  let body = _.merge({\n    type: 'about:blank',\n    title: http.STATUS_CODES[status],\n    status,\n    instance: this.instance\n  }, extensions);\n  this.send(body, contentType);\n\n  let err = new Error();\n  err.contentType = 'application/problem+json';\n  err.body = body;\n  return err;\n};\n\nlet _reqGetBody = function() {\n  let {body} = this;\n  try {\n    if (/[/+]json$/.test(this.get('content-type'))) {\n      body = JSON.parse(this.body);\n    }\n  } catch (syntaxErrors) {\n    return this.res.sendError(400, {errors: syntaxErrors});\n  }\n\n  if (!_.isUndefined(this.validate)) {\n    let valid = this.validate(body);\n    if (!valid) {\n      return this.res.sendError(422, {\n        errors: this.validate.errors,\n        schema: this.validate.schema\n      });\n    }\n  }\n\n  return body;\n};\n\nlet _initExpress = function() {\n  return bootstrapMiddleware(async function(req, res, next) {\n    req.log = req.ctx.log;\n    res.log = req.log;\n    res.instance = getRequestInstance(req);\n\n    req.getBody = _.memoize(_.bind(_reqGetBody, req));\n    req.getSelfUrl = function() {\n      return getSelfUrl({req});\n    };\n    req.getPaginationUrl = function(args) {\n      args.req = req;\n      return getPaginationUrl(args);\n    };\n\n    res.addLink = _.bind(_resAddLink, res);\n\n    let oldSend = res.send;\n    res.send = _.bind(_resSend, res, oldSend);\n    res.sendError = _.bind(_resSendError, res);\n    next();\n  });\n};\n\nlet _xForward = function() {\n  return bootstrapMiddleware(async function(req, _res, next) {\n    req.headers = _.mapKeys(req.headers, function(_value, key) {\n      return _.replace(key, /^X-Forward-/, '');\n    });\n    next();\n  });\n};\n\nexport let getSelfUrl = function({req}) {\n  let {env} = req.ctx;\n  let selfUrl = urlParse(`${env.API_SECONDARY_BASE_URL}${req.originalUrl}`);\n  return selfUrl;\n};\n\nexport let getPaginationUrl = function({\n  req,\n  perPage = per_page, // eslint-disable-line no-use-before-define\n  ref,\n  // FIXME deprecated\n  per_page // eslint-disable-line camelcase\n}) {\n  let pageUrl = getSelfUrl({req});\n\n  // FIXME use url.URL when AWS Node.js is upgraded from 6.10\n  _.merge(pageUrl, {\n    query: {\n      per_page: perPage,\n      ref\n    }\n  });\n  pageUrl = urlParse(urlFormat(pageUrl));\n  return pageUrl;\n};\n\nexport let express = function(e, _ctx, _next) {\n  let app = _express();\n\n  app.disable('x-powered-by');\n  app.disable('etag');\n  app.enable('trust proxy');\n  app.set('json spaces', 2);\n\n  // FIXME hack!!!\n  let host = _.get(e, 'headers.Host', _.get(e, 'headers.host'));\n  if (_.startsWith(host, 'api-git.')) {\n    // using the api-git apigateway-domainname (ci stack)\n    let basePath = _.split(urlLib.parse(e.path).pathname, '/')[1];\n    app.lazyrouter();\n    app.use(`/${basePath}`, app._router);\n  }\n\n  app.use(responseTime());\n  app.use(cors({\n    exposedHeaders: [\n      'location',\n      'x-response-time'\n    ],\n    maxAge: 24 * 60 * 60 // 24 hours\n  }));\n  app.use(bearerToken());\n  app.use(_initExpress());\n  app.use(_xForward());\n\n  app.use(bootstrapMiddleware(async function(_req, res, next) {\n    res.set('cache-control', 'max-age=0, no-store');\n    next();\n  }));\n\n  return app;\n};\n\n// using console.log instead of the logger on purpose\nexport let bootstrap = function(fn, {pkg}) {\n  return bootstrapLambda(async function(e, ctx, next) {\n    let app;\n    await _.consoleLogTime(\n      'aws-util-firecloud.express.bootstrap: Creating express app...',\n      async function() {\n        app = express(e, ctx, next);\n      }\n    );\n\n    await _.consoleLogTime(\n      'aws-util-firecloud.express.bootstrap: Setting up custom express...',\n      async function() {\n        await fn(app, e, ctx, next);\n      }\n    );\n\n    await _.consoleLogTime(\n      'aws-util-firecloud.express.bootstrap: Creating HTTP server (handling request)...',\n      async function() {\n        let http = new LambdaHttp(e, ctx, next);\n        http.createServer(app);\n      }\n    );\n  }, {pkg});\n};\n\nexport default exports;\n"]}