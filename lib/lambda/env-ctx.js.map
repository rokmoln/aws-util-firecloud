{"version":3,"sources":["../../src/lambda/env-ctx.js"],"names":[],"mappings":"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","file":"env-ctx.js","sourcesContent":["import _ from 'lodash-firecloud';\nimport aws from 'aws-sdk';\n\nlet _memoizeResolver = function({\n  ctx,\n  tags = [\n    'default'\n  ]\n}) {\n  let {\n    env\n  } = ctx;\n\n  return [\n    env.AWS_ACCOUNT_ID,\n    env.AWS_LAMBDA_FUNCTION_ALIAS,\n    env.AWS_LAMBDA_FUNCTION_NAME,\n    env.AWS_REGION,\n    env.ENV_NAME\n  ].concat(tags).join();\n};\n\nlet _get = async function({ctx, tags}) {\n  let {\n    env\n  } = ctx;\n  // eslint-disable-next-line fp/no-arguments\n  let cacheKey = _memoizeResolver(...arguments);\n  let s3 = new aws.S3({\n    region: env.AWS_REGION,\n    signatureVersion: 'v4'\n  });\n\n  let Body;\n  let ETag;\n\n  await ctx.log.trackTime('aws-util-firecloud.lambda._get: Fetching env ctx...', async function() {\n    let result = await s3.getObject({\n      Bucket: env.S3_CONFIG_BUCKET,\n      Key: `${env.ENV_NAME}.json`,\n      IfMatch: (_.defaultTo(_get.oldCache[cacheKey], {})).etag\n    }).promise();\n\n    ({\n      Body,\n      ETag\n    } = result);\n  });\n  Body = JSON.parse(Body.toString());\n\n  let newCtx = {};\n  _.forEach(tags, function(tag) {\n    newCtx = _.merge(newCtx, _.defaultTo(Body[tag], {}));\n  });\n\n  return {\n    ctx: newCtx,\n    etag: ETag,\n    lastFetched: Date.now()\n  };\n};\n_get = _.memoize(_get, _memoizeResolver);\n_get.oldCache = new _.memoize.Cache();\n\nlet _getAndRefresh = async function(...args) {\n  let cacheKey = _memoizeResolver(...args);\n  let cachedResult = _get.cache[cacheKey];\n  cachedResult = _.defaultTo(cachedResult, _get.oldCache[cacheKey]);\n  cachedResult = _.defaultTo(cachedResult, {});\n  let aMinuteAgo = Date.now() - 60 * 1000;\n\n  if (!cachedResult.ctx) {\n    cachedResult = await _get(...args);\n  }\n\n  if (cachedResult.lastFetched < aMinuteAgo) {\n    _get.oldCache.set(cacheKey, _get.cache[cacheKey]);\n    _get.cache.delete(cacheKey);\n    // don't await, we refresh the ctx for next call\n    // await _get(...args);\n    _get(...args);\n  }\n\n  return cachedResult.ctx;\n};\n\nexport let merge = async function({e, ctx, pkg}) {\n  let AWS_ACCOUNT_ID =\n      _.split(_.get(ctx, 'invokedFunctionArn', ''), ':')[4];\n  AWS_ACCOUNT_ID =\n    _.defaultTo(_.get(e, 'requestContext.accountId'), AWS_ACCOUNT_ID);\n\n  let AWS_REGION =\n      _.split(_.get(ctx, 'invokedFunctionArn', ''), ':')[3];\n\n  let pkgNameRE = _.replace(pkg.name, /([.-])/, '\\\\$1');\n  let ENV_NAME =\n      _.split(_.get(ctx, 'invokedFunctionArn', ''), ':')[6];\n  ENV_NAME = _.replace(ENV_NAME, new RegExp(`\\\\-${pkgNameRE}$`), '');\n\n  let AWS_LAMBDA_FUNCTION_NAME =\n      _.split(_.get(ctx, 'invokedFunctionArn', ''), ':')[6];\n\n  let AWS_LAMBDA_FUNCTION_ALIAS =\n      _.split(_.get(ctx, 'invokedFunctionArn', ''), ':')[7];\n  AWS_LAMBDA_FUNCTION_ALIAS = _.defaultTo(AWS_LAMBDA_FUNCTION_ALIAS, '$LATEST');\n\n  _.defaultsDeep(ctx, {\n    env: e.stageVariables\n  }, {\n    env: {\n      AWS_ACCOUNT_ID,\n      AWS_LAMBDA_FUNCTION_ALIAS,\n      AWS_LAMBDA_FUNCTION_NAME,\n      AWS_REGION,\n      ENV_NAME\n    }\n  }, {\n    env: e.stageVariables\n  }, {\n    env: {\n      // AWS does not allow empty-string stage variables...\n      API_BASE_PATH: '',\n      API_SECONDARY_BASE_PATH: ''\n    }\n  }, {\n    env: process.env\n  });\n\n  let envCtx = await _getAndRefresh({\n    ctx,\n    tags: [\n      'lambdas',\n      `lambdas/${pkg.name}`\n    ]\n  });\n  _.defaultsDeep(ctx, envCtx);\n};\n\nexport default exports;\n"]}