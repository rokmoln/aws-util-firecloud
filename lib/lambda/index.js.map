{"version":3,"sources":["../../src/lambda/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import _ from 'lodash-firecloud';\n\nimport inspect from './inspect';\n\nimport {\n  merge as mergeEnvCtx\n} from './env-ctx';\n\nimport {\n  setup as setupLogger\n} from './logger';\n\nlet _cleanup = async function({ctx}) {\n  if (global && global.gc) {\n    await ctx.log.trackTime(\n      'Garbage collection on demand...',\n      async function() {\n        global.gc();\n      }\n    );\n  }\n};\n\nlet _bootstrap = async function(fn, e, ctx, pkg) {\n  // temporary logger\n  setupLogger({ctx});\n\n  await ctx.log.trackTime(\n    'Merging env ctx...',\n    async function() {\n      await mergeEnvCtx({e, ctx, pkg});\n    }\n  );\n\n  await ctx.log.trackTime(\n    'Setting up logger...',\n    async function() {\n      setupLogger({ctx});\n      ctx.log.trace(`Logger started with level=${ctx.log.level()}`, {\n        e,\n        ctx\n      });\n    }\n  );\n\n  await ctx.log.trackTime(\n    'Inspecting...',\n    async function() {\n      await inspect({e, ctx});\n    }\n  );\n\n  let result;\n  await ctx.log.trackTime(\n    'Running fn...',\n    async function() {\n      result = await fn(e, ctx);\n      await ctx.log.trace('Fn result:', {\n        result\n      });\n    }\n  );\n\n  // don't wait for cleanup on purpose\n  _cleanup({ctx});\n\n  return result;\n};\n\nexport let getRequestInstance = function({ctx}) {\n  return `${ctx.invokedFunctionArn}#request:${ctx.awsRequestId}`;\n};\n\nexport let bootstrap = function(fn, {\n  pkg\n}) {\n  process.on('uncaughtException', function(err) {\n    // eslint-disable-next-line no-console\n    console.error('FATAL uncaughtException');\n    // eslint-disable-next-line no-console\n    console.error(err.stack);\n    // eslint-disable-next-line no-process-exit\n    process.exit(1);\n  });\n\n  process.on('unhandledRejection', function(err) {\n    // eslint-disable-next-line no-console\n    console.error('FATAL unhandledRejection');\n    // eslint-disable-next-line no-console\n    console.error(err.stack);\n    // eslint-disable-next-line no-process-exit\n    process.exit(1);\n  });\n\n  return async function(e, ctx, awsNext) {\n    try {\n      let result = await _bootstrap(fn, e, ctx, pkg);\n      return awsNext(undefined, result);\n    } catch (err) {\n      // proxying the err to awsNext would not reset state (kill lambda)\n      // return awsNext(err);\n\n      // eslint-disable-next-line no-console\n      console.error('FATAL try-catch-lambda-bootstrap');\n      // eslint-disable-next-line no-console\n      console.error(err.stack);\n      // eslint-disable-next-line no-process-exit\n      process.exit(1);\n    }\n  };\n};\n\nexport default exports;\n"]}