<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/cfn/build.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/cfn</a> build.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/64</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/17</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/50</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102</td><td class="line-coverage quiet"><span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import '../bo<span class="cstat-no" title="statement not covered" >otstrap';<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ></span></span></span></span>
&nbsp;
import _ from 'lodash-f<span class="cstat-no" title="statement not covered" >irecloud';<span class="cstat-no" title="statement not covered" ></span></span>
import fs <span class="cstat-no" title="statement not covered" >from 'fs';<span class="cstat-no" title="statement not covered" ></span></span>
import path <span class="cstat-no" title="statement not covered" >from 'path';<span class="cstat-no" title="statement not covered" ></span></span>
&nbsp;
import {<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
  reduceToDependsOn
} from './';
&nbsp;
export let sortedRea<span class="cstat-no" title="statement not covered" >ddir = async function({di<span class="fstat-no" title="function not covered" >r}</span>) {<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
  let files = fs<span class="cstat-no" title="statement not covered" >.readdirSync(dir);</span>
  fi<span class="cstat-no" title="statement not covered" >les = _.sortBy(files);</span>
  fi<span class="cstat-no" title="statement not covered" >les = _.map(files, function(file) {<span class="fstat-no" title="function not covered" ></span></span>
    re<span class="cstat-no" title="statement not covered" >turn path.join(dir, file);</span>
  });
  re<span class="cstat-no" title="statement not covered" >turn files;</span>
};<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
&nbsp;
export let b<span class="cstat-no" title="statement not covered" >uild = async func<span class="fstat-no" title="function not covered" >ti</span>on({<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
  dir,
  env,
  incs = []<span class="branch-0 cbranch-no" title="branch not covered" >,</span>
  partial = fa<span class="branch-0 cbranch-no" title="branch not covered" >lse,</span>
  resNs
}) {
  let tpl = {}<span class="cstat-no" title="statement not covered" >;</span>
&nbsp;
  if<span class="cstat-no" title="statement not covered" > (!_.isUndefined(dir)) {</span>
    if<span class="cstat-no" title="statement not covered" > (fs.existsSync(dir)) {</span>
      let dirIncs = _.<span class="cstat-no" title="statement not covered" >filter(await sortedReaddir({dir}), function(inc) {<span class="fstat-no" title="function not covered" ></span></span>
        re<span class="cstat-no" title="statement not covered" >turn /\.cfn\.js$/.test(inc);</span>
      });
      in<span class="cstat-no" title="statement not covered" >cs = _.concat(incs, dirIncs);</span>
    }
  }
&nbsp;
  let vars = {}<span class="cstat-no" title="statement not covered" >;</span>
  if<span class="cstat-no" title="statement not covered" > (fs.existsSync(`${dir}/vars.js`)) {</span>
    // eslint-disable-next-line global-require
    va<span class="cstat-no" title="statement not covered" >rs = await require(`${dir}/vars.js`).default({env, resNs});</span>
  }
&nbsp;
  aw<span class="cstat-no" title="statement not covered" >ait Promise.all(_.map(incs, async function(inc) {<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ><span class="fstat-no" title="function not covered" ></span></span></span></span>
    if (<span class="cstat-no" title="statement not covered" >!path.isAbsolute(inc)) {</span>
      inc <span class="cstat-no" title="statement not covered" >= path.join(process.cwd(), inc);</span>
    }
    // eslint-disable-next-line global-require
    let main = requ<span class="cstat-no" title="statement not covered" >ire(inc).default;</span>
    let partialTpls = awai<span class="cstat-no" title="statement not covered" >t main({</span>
      env,
      resNs,
      vars
    });
&nbsp;
    // allow the main function to return multiple partial templates
    part<span class="cstat-no" title="statement not covered" >ialTpls = _.isArray(partialTpls) ? partialTpls : [partialTpls];</span>
&nbsp;
    _.me<span class="cstat-no" title="statement not covered" >rge(tpl, ...partialTpls);</span>
  }));<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span>
&nbsp;
  if<span class="cstat-no" title="statement not covered" > (!partial) {</span>
    // CloudFormation behaviour becomes safer (as per AWS support conversations)
    // if you spell out the DependsOn field, rather than rely on CloudFormation
    // to imply that based on Refs and Fn::GetAtt...
    _.<span class="cstat-no" title="statement not covered" >forEach(_.pickBy(tpl.Resources), function(Resource) {<span class="fstat-no" title="function not covered" ></span></span>
      let deps = _.<span class="cstat-no" title="statement not covered" >reduce(Resource, reduceToDependsOn, []);</span>
      // keep only dependencies on other resources
      de<span class="cstat-no" title="statement not covered" >ps = _.intersection(deps, _.keys(tpl.Resources));</span>
      Re<span class="cstat-no" title="statement not covered" >source.DependsOn = _.defaultTo(Resource.DependsOn, []);</span>
      Re<span class="cstat-no" title="statement not covered" >source.DependsOn = [].concat(Resource.DependsOn).concat(deps);</span>
      Re<span class="cstat-no" title="statement not covered" >source.DependsOn = Resource.DependsOn.length ? Resource.DependsOn : undefined;</span>
    });
&nbsp;
    // CloudFormation does not have consistent rules for Sids (statement ids)
    _.<span class="cstat-no" title="statement not covered" >forEach(_.pickBy(tpl.Resources), function(Resource) {<span class="fstat-no" title="function not covered" ></span></span>
      sw<span class="cstat-no" title="statement not covered" >itch (Resource.Type) {</span>
      case 'AWS::IAM::ManagedPolicy':
        _.fo<span class="cstat-no" title="statement not covered" >rEach(Resource.Properties.PolicyDocument.Statement, function(Stmt) {<span class="fstat-no" title="function not covered" ></span></span>
          Stmt<span class="cstat-no" title="statement not covered" >.Sid = _.camelCase(Stmt.Sid);</span>
        });
        brea<span class="cstat-no" title="statement not covered" >k;</span>
      case 'AWS::KMS::Key':
        _.fo<span class="cstat-no" title="statement not covered" >rEach(Resource.Properties.KeyPolicy.Statement, function(Stmt) {<span class="fstat-no" title="function not covered" ></span></span>
          Stmt<span class="cstat-no" title="statement not covered" >.Sid = _.camelCase(Stmt.Sid);</span>
        });
        brea<span class="cstat-no" title="statement not covered" >k;</span>
      case 'AWS::S3::BucketPolicy':
        _.fo<span class="cstat-no" title="statement not covered" >rEach(Resource.Properties.PolicyDocument.Statement, function(Stmt) {<span class="fstat-no" title="function not covered" ></span></span>
          Stmt<span class="cstat-no" title="statement not covered" >.Sid = _.camelCase(Stmt.Sid);</span>
        });
        brea<span class="cstat-no" title="statement not covered" >k;</span>
      default:
      }
    });
  }
&nbsp;
  re<span class="cstat-no" title="statement not covered" >turn tpl;</span>
};<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" ></span></span></span></span>
&nbsp;
export default build;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu Mar 01 2018 12:03:08 GMT+0100 (CET)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
